# **コピー支援モジュール仕様書（最終改訂版）**

## 1. **モジュール名**
**`copy_support`**

## 2. **概要**
`copy_support` モジュールは、クロスプラットフォーム（Windows, macOS, Linux）に対応したファイルコピーの支援ツールです。特に、Windows環境ではアクセス制限のかかったファイルのコピーを `robocopy` を利用して実行し、macOSやLinuxでは `rsync` を使用します。並列処理によって大規模なファイルやディレクトリのコピーを効率化し、失敗したコピーについては再実行を行います。GUIアプリケーションとの連携を考慮し、進行状況やエラーメッセージをコールバック関数で報告します。

### 2.1 **フォールバック戦略**
**必須ツールとしての位置付け**: `robocopy`（Windows）や `rsync`（macOS/Linux）がインストールされていない場合は、コピー処理を中断し、ユーザーにツールのインストールを促します。これにより、標準的な `shutil` によるフォールバックは廃止し、確実なコピーを保証します。ツールが見つからない場合やバージョン不一致の場合、クリティカルエラーとして扱います。

### 2.2 **セキュリティポリシー**
- **権限の取り扱い**: モジュールはコピー元/先のファイル権限を考慮し、コピー処理がユーザーの権限範囲内で行われることを保証します。アクセス制限されたファイルをコピーする際は、適切な警告や確認をユーザーに提示します。管理者権限の取得が必要な場合は、実行中にユーザーに通知し、権限昇格を求めます。
- **機密情報保護**: コピー対象のファイルに機密情報が含まれる可能性がある場合は、ユーザーに警告を表示し、コピー対象を確認させる手順を導入します。

## 3. **機能一覧**
### 3.1 ファイルコピー機能
- **Windows**: `robocopy` を使用してアクセス制限のあるファイルも含め、強力なファイルコピーを実行します。`robocopy` が見つからない場合は、ユーザーにインストールを促し、コピー処理を中断します。
- **macOS/Linux**: `rsync` を使用し、再開可能なファイルコピーをサポートします。`rsync` が見つからない場合は、ユーザーにインストールを促し、コピー処理を中断します。

### 3.2 並列コピー処理
- 複数のファイル/ディレクトリを並列でコピーし、システムリソースを効率的に活用。並列処理のスレッド数はデフォルトで `os.cpu_count() * 2` に設定されますが、ユーザーが任意のスレッド数を指定できます。

### 3.3 リトライ機能
- コピーに失敗した場合、最大3回まで再実行。3回失敗してもコピーできなかったファイルはログに記録し、残りのコピー処理に進みます。

### 3.4 アクセス権限チェック
- コピー前にファイルやディレクトリのアクセス権限をチェックし、コピー可能かどうか確認します。アクセスできないファイル/ディレクトリは、ユーザーに通知し、ログに記録します。

### 3.5 進行状況のリアルタイムフィードバック
- ファイルごとの進行状況やエラーメッセージ、完了通知をコールバック関数を通じてリアルタイムで報告。GUIアプリケーションなど、呼び出し元で進行状況バーやエラーメッセージを表示することが可能です。進行状況はバイト単位でも取得可能です。

### 3.6 ファイル属性とメタデータのコピー
- **macOS/Linux**: `rsync` の `-E` オプションで拡張属性（ACL、リソースフォークなど）を保持。`-A` オプションでACLをコピー。これらのオプションはユーザーが指定可能。
- **Windows**: `robocopy` でファイルのパーミッションやメタデータ（所有者情報、タイムスタンプなど）をコピー。

### 3.7 リンクファイルの扱い
- シンボリックリンクやハードリンクについては、デフォルトでリンク先の実体をコピーしますが、ユーザーがリンクとしてコピーするか、実体をコピーするかを選択可能です（`follow_symlinks` パラメータ）。

### 3.8 完了通知
- コピー処理が全て完了した時点で、呼び出し元に完了通知を送信します。完了時には、総ファイル数、コピーにかかった時間、成功/失敗のファイル数、総データ量なども報告します。

## 4. **モジュールの設計**
### 4.1 ディレクトリ構造
```
copy_support/
│
├── __init__.py          # モジュール初期化
├── main.py              # メインのコピー処理
├── mac_linux.py         # macOS/Linux用の処理
└── win.py               # Windows用の処理
```

### 4.2 関数設計と呼び出しフロー
- `copy_with_progress` が全体のコピー処理を管理し、プラットフォームに応じて `robocopy_with_logging` または `rsync_with_logging` を呼び出します。それぞれの関数は `copy_with_retry_and_logging` を使って、最大3回までの再試行を行います。

#### フロー:
1. `copy_with_progress` を呼び出す。
2. プラットフォーム依存のコピー関数（`robocopy_with_logging` か `rsync_with_logging`）を選択。
3. コピーの進行状況を `progress_callback` で通知し、エラーは `error_callback` で報告。
4. 完了後、`completion_callback` でコピー結果を通知。

## 5. **コールバック関数の仕様**
### 5.1 進行状況のコールバック
進行状況をリアルタイムで報告するために、ファイルごとに呼び出されます。バイト単位での進行状況も報告可能です。

#### サンプル実装
```python
def update_progress(copied_files, total_files, copied_bytes, total_bytes):
    """
    コールバックで進行状況を更新

    Parameters:
    copied_files (int): コピーされたファイル数
    total_files (int): コピー対象の総ファイル数
    copied_bytes (int): コピーされたバイト数
    total_bytes (int): 総バイト数
    """
```

### 5.2 エラーメッセージのコールバック
コピー失敗時に呼び出され、失敗したファイルとエラー内容をGUIに報告します。エラーメッセージや例外オブジェクトの詳細も含めます。

#### サンプル実装
```python
def show_error(file, attempt, retries, error_message):
    """
    エラー発生時のコールバック

    Parameters:
    file (str): 失敗したファイル名
    attempt (int): 現在の試行回数
    retries (int): 最大試行回数
    error_message (str): エラーメッセージ
    """
```

### 5.3 コピー完了のコールバック
全てのコピー処理が完了した際に呼び出され、完了メッセージや処理後の操作を行います。完了時には、総ファイル数、コピー時間、成功/失敗のファイル数、総データ量を報告します。

#### サンプル実装
```python
def show_completion(total_files, total_time, success_count, failure_count, total_bytes):


    """
    全ファイルのコピー完了時に呼ばれるコールバック

    Parameters:
    total_files (int): 総ファイル数
    total_time (float): 総コピー時間（秒）
    success_count (int): 成功したファイル数
    failure_count (int): 失敗したファイル数
    total_bytes (int): 総データ量（バイト）
    """
```

## 6. **テスト計画**
### 6.1 単体テスト
- 各機能（ファイルコピー、再試行、並列処理、アクセスチェック）の単体テストを実施。
- **テストケース例**: アクセス権限がないファイル、大容量ファイル、ネットワークドライブ、ACL付きファイル、シンボリックリンク、壊れたリンクなどのエッジケースを想定。

### 6.2 統合テスト
- Windows、macOS、Linux上での動作確認を行い、GUIと統合して進行状況やエラーが正しく表示されるかを確認します。

### 6.3 バージョンチェック
- `robocopy` や `rsync` のバージョンを確認し、必要なバージョンを満たしているかチェック。問題があれば、ユーザーに警告を表示します。

## 7. **ライセンスと依存関係**
### 7.1 ライセンス
- 本モジュールは **MITライセンス** で提供されます。

### 7.2 依存関係
- 使用する外部コマンド・ライブラリ:
  - **Windows**: `robocopy`（必要バージョン：Windows 10以降に標準インストール）
  - **macOS/Linux**: `rsync`（バージョン 3.1以上推奨）

---

### **最終的な改善ポイント**
1. **フォールバックの廃止**と**クリティカルエラー処理**を導入し、コピー処理の信頼性を確保。
2. **macOS/Linuxの特殊ファイル対応**や**ファイル属性のコピー**に関するオプションの追加。
3. **バージョンチェック機能**の導入と、エラー時の適切な対応策の提示。
4. **詳細なテスト計画**とエッジケースのテストカバレッジを拡充。
5. **セキュリティポリシー**の強化により、アクセス制限や機密情報の取り扱いを慎重に行う。
6. **ユーザードキュメントとAPIリファレンスの作成**で、モジュールの使いやすさを向上。

---
